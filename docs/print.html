<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Crafteo - Docker Training</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="welcome.html">Crafteo - Docker Training</a></li><li class="chapter-item expanded affix "><li class="part-title">Introduction</li><li class="chapter-item expanded "><a href="intro/base.html"><strong aria-hidden="true">1.</strong> Basics</a></li><li class="chapter-item expanded "><a href="intro/port.html"><strong aria-hidden="true">2.</strong> Exposition de ports</a></li><li class="chapter-item expanded "><a href="intro/misc.html"><strong aria-hidden="true">3.</strong> Quelques manipulations...</a></li><li class="chapter-item expanded "><a href="intro/exec.html"><strong aria-hidden="true">4.</strong> Commandes dans un container</a></li><li class="chapter-item expanded "><a href="intro/fs.html"><strong aria-hidden="true">5.</strong> Syst√®me de fichier</a></li><li class="chapter-item expanded "><a href="intro/bind.html"><strong aria-hidden="true">6.</strong> Bind Mount</a></li><li class="chapter-item expanded "><a href="intro/volume.html"><strong aria-hidden="true">7.</strong> Volumes</a></li><li class="chapter-item expanded "><a href="intro/build.html"><strong aria-hidden="true">8.</strong> Build d'images</a></li><li class="chapter-item expanded affix "><li class="part-title">Docker Compose</li><li class="chapter-item expanded "><a href="compose/base.html"><strong aria-hidden="true">9.</strong> Base</a></li><li class="chapter-item expanded "><a href="compose/build.html"><strong aria-hidden="true">10.</strong> Build</a></li><li class="chapter-item expanded "><a href="compose/cli.html"><strong aria-hidden="true">11.</strong> CLI</a></li><li class="chapter-item expanded "><a href="compose/advanced.html"><strong aria-hidden="true">12.</strong> Advanced</a></li><li class="chapter-item expanded affix "><li class="part-title">Networking</li><li class="chapter-item expanded "><a href="network/bridge.html"><strong aria-hidden="true">13.</strong> Bridge</a></li><li class="chapter-item expanded "><a href="network/bridge-advanced.html"><strong aria-hidden="true">14.</strong> Bridge advanced</a></li><li class="chapter-item expanded "><a href="network/host.html"><strong aria-hidden="true">15.</strong> Host</a></li><li class="chapter-item expanded affix "><li class="part-title">Data</li><li class="chapter-item expanded "><a href="data/bind.html"><strong aria-hidden="true">16.</strong> Bind mount</a></li><li class="chapter-item expanded "><a href="data/volume.html"><strong aria-hidden="true">17.</strong> Volumes</a></li><li class="chapter-item expanded "><a href="data/tmpfs.html"><strong aria-hidden="true">18.</strong> tmpfs</a></li><li class="chapter-item expanded "><a href="data/container.html"><strong aria-hidden="true">19.</strong> Container layer</a></li><li class="chapter-item expanded "><a href="data/copy.html"><strong aria-hidden="true">20.</strong> Copy</a></li><li class="chapter-item expanded affix "><li class="part-title">Image & Build</li><li class="chapter-item expanded "><a href="img/cli.html"><strong aria-hidden="true">21.</strong> CLI</a></li><li class="chapter-item expanded "><a href="img/build.html"><strong aria-hidden="true">22.</strong> Build basic</a></li><li class="chapter-item expanded "><a href="img/build-optim.html"><strong aria-hidden="true">23.</strong> Build optimization</a></li><li class="chapter-item expanded "><a href="img/entrypoint.html"><strong aria-hidden="true">24.</strong> Entrypoint</a></li><li class="chapter-item expanded "><a href="img/advanced.html"><strong aria-hidden="true">25.</strong> Advanced</a></li><li class="chapter-item expanded affix "><li class="part-title">Registry</li><li class="chapter-item expanded "><a href="registry/harbor.html"><strong aria-hidden="true">26.</strong> Harbor</a></li><li class="chapter-item expanded "><a href="registry/hub.html"><strong aria-hidden="true">27.</strong> Docker Hub</a></li><li class="chapter-item expanded "><a href="registry/private.html"><strong aria-hidden="true">28.</strong> Registry priv√©e</a></li><li class="chapter-item expanded affix "><li class="part-title">Docker en Production et concepts avanc√©s</li><li class="chapter-item expanded "><a href="advanced/dockerize-from-source.html"><strong aria-hidden="true">29.</strong> Dockerizer une application</a></li><li class="chapter-item expanded "><a href="advanced/traefik.html"><strong aria-hidden="true">30.</strong> HTTPS and Reverse Proxy (Traefik)</a></li><li class="chapter-item expanded "><a href="advanced/best-practices.html"><strong aria-hidden="true">31.</strong> Bonnes pratiques</a></li><li class="chapter-item expanded "><a href="advanced/logging.html"><strong aria-hidden="true">32.</strong> Logging (ELK Stack)</a></li><li class="chapter-item expanded "><a href="advanced/monitoring.html"><strong aria-hidden="true">33.</strong> Monitoring (Prometheus)</a></li><li class="chapter-item expanded "><a href="advanced/engine.html"><strong aria-hidden="true">34.</strong> Configuration du daemon</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Crafteo - Docker Training</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/PierreBeucher/docker.training.crafteo.io" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="crafteo---docker-training"><a class="header" href="#crafteo---docker-training">Crafteo - Docker Training</a></h1>
<p>Bienvenue sur les exercices de la formation Docker ! Suivre les liens du menu pour y acc√©der aux exercices.</p>
<p>Plus d'info sur <a href="https://crafteo.io">crafteo.io</a> et <a href="https://blog.crafteo.io">blog.crafteo.io</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="docker---basics"><a class="header" href="#docker---basics">Docker - basics</a></h1>
<pre><code>docker --help|-h
docker [COMMAND] --help
docker run --help
docker image -h

# Run a container
docker run [OPTIONS] IMAGE

# List existing containers
&gt; docker ps [-a]

# Show container logs
&gt; docker logs [OPTIONS] CONTAINER

# start, stop, restart containers
&gt; docker start|stop|restart CONTNER
</code></pre>
<h2 id="exercices"><a class="header" href="#exercices">Exercices</a></h2>
<p>Lancer un container utilisant l'image <strong><code>httpd:alpine</code></strong> (image officielle Apache HTTP server) <strong>en mode d√©tach√© (daemon)</strong> et le <strong>nommer <code>myapache</code></strong></p>
<ul>
<li><code>docker run</code> devra rendre la main et afficher un ID de container</li>
</ul>
<hr />
<p>V√©rifier que <code>myapache</code> <strong>existe et est actif</strong></p>
<ul>
<li>Le container doit √™tre au status <code>Up</code></li>
</ul>
<hr />
<p>Afficher les <strong>2 derni√®res lignes</strong> de logs de myapache et <strong>suivre les changements</strong></p>
<hr />
<p><strong>Arr√™ter</strong> puis <strong>red√©marrer</strong> le container <code>myapache</code></p>
<ul>
<li>Plusieurs solutions possible utilisant le m√™me set de commandes</li>
</ul>
<hr />
<p><strong>Supprimer</strong> le container <code>myapache</code></p>
<ul>
<li>Des actions pr√©alables peuvent √™tre requises</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="docker---exposing-container-ports"><a class="header" href="#docker---exposing-container-ports">Docker - exposing container ports</a></h1>
<pre><code># expose host port 8080 on container port 80
docker run -d --name myport -p 8080:80 httpd:alpine

# try it out!
curl localhost:8080

# help may always be useful
docker run -h
</code></pre>
<h2 id="exercices-1"><a class="header" href="#exercices-1">Exercices</a></h2>
<p>Lancer 2 containers <code>httpd:alpine</code> exposant chacun leur port <code>80</code> sur des ports diff√©rents (tel que <code>8081</code> et <code>8082</code>) et v√©rifier le fonctionnement</p>
<ul>
<li>l'option <code>-d</code> peut √™tre utile pour lancer le container en background</li>
<li>curl <code>localhost:8081</code> et <code>localhost:8082</code> permettront de tester avec l'un et l'autre</li>
<li>possible aussi de tester avec votre navigateur web </li>
</ul>
<hr />
<p>Lancer un container <code>httpd:alpine</code> utilisant le <strong>r√©seau h√¥te</strong> directement et tester</p>
<ul>
<li>Apache se lancera directement sur le r√©seau de la machine h√¥te en se bindant au port <code>80</code></li>
<li>Si le port <code>80</code> de la machine hote est d√©j√† utilis√© par un autre processus il y aura un conflit de port</li>
<li>Pour voir les process utilisant le port <code>80</code> sur la machine hote:
<pre><code class="language-sh">sudo netstat -lnap | grep -e &quot;:80\s&quot;
</code></pre>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="docker---misc-commands"><a class="header" href="#docker---misc-commands">Docker - misc commands</a></h1>
<h2 id="exercices-2"><a class="header" href="#exercices-2">Exercices</a></h2>
<p>Puller l‚Äôimage <code>httpd</code> tagg√©e <code>2.4.41-alpine</code> et lancer un nouveau container en mode d√©tach√© sans le nommer</p>
<ul>
<li><code>docker pull -h</code>, si jamais...</li>
<li>penser √† r√©cup√©rer l'identifiant unique de votre container donn√© en sortie de <code>docker run</code></li>
</ul>
<hr />
<p>Renommer le container lanc√© pr√©c√©demment en <code>myalpine</code> en utilisant son identifiant unique (pas son nom)</p>
<ul>
<li>l'occasion de d√©couvrir une nouvelle commande?</li>
</ul>
<hr />
<p>Afficher l‚Äôensemble des processus du container <code>myalpine</code></p>
<ul>
<li>√©quivalent de Linux <code>top</code> ou <code>ps</code> pour un container Docker</li>
</ul>
<hr />
<p><strong>Inspecter</strong> le container <code>myalpine</code> et trouver la <strong>commande lanc√©e au d√©marrage</strong></p>
<ul>
<li>il s'agit du processus qui sera lanc√© au d√©marrage du container</li>
</ul>
<hr />
<p>Obtenir les <strong>statistiques</strong>  d‚Äôusage ressources (CPU, RAM...) du container</p>
<ul>
<li>pratique pour d√©bugger dans certain cas</li>
</ul>
<hr />
<p><strong>Mettre √† jour</strong> la configuration du container <code>myalpine</code> pour le red√©marrer automatiquement lors du boot de la machine</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="docker---exec-and-co"><a class="header" href="#docker---exec-and-co">Docker - <code>exec</code> and co.</a></h1>
<pre><code># Execute command inside a container
docker exec [OPTIONS] CONTAINER COMMAND [ARG...]

# delete /tmp/somefile in container
docker exec mycontainer rm /tmp/somefile

# need help?
docker exec -h 
</code></pre>
<h2 id="exercices-3"><a class="header" href="#exercices-3">Exercices</a></h2>
<p>Lancer un container <code>httpd:alpine</code> exposant <code>8083:80</code> et y
<strong>ouvrir une session shell interactive</strong> avec <strong>pseudo-TTY</strong> et explorer le syst√®me de fichier (i.e. filesystem ou FS)</p>
<ul>
<li>le r√©sultat est √©quivalent √† ouvrir une session SSH sur une machine virtuelle... m√™me si le fonctionnement n'a absolument rien √† voir</li>
<li>le FS de votre container est-il le m√™me que celui de votre machine? </li>
</ul>
<hr />
<p>Modifier le fichier <code>htdocs/index.html</code> dans le container et v√©rifier ce que renvoi <code>localhost:8083</code></p>
<ul>
<li>Utiliser une commande <code>echo &quot;Test content&quot; &gt; index.html</code> ou <code>vi</code></li>
<li>Que se passe-t-il si on lance un autre container utilisant la m√™me image? Lancer un autre container <code>httpd:alpine</code> exposant <code>8084:80</code> et comparer!</li>
</ul>
<hr />
<p>Lister les process du container lanc√© pr√©c√©demment <strong>depuis le container lui-m√™me</strong>. V√©rifier si ce m√™me processus est visible depuis la machine h√¥te. </p>
<ul>
<li><code>ps -ef</code> permet d'afficher les processus machine et/ou du container</li>
<li><code>pstree -as PID</code> permet d'afficher l'arbre de processus pour le processus <code>PID</code> (ex. <code>pstree -as 29698</code>)</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="docker---file-system"><a class="header" href="#docker---file-system">Docker - File System</a></h1>
<p>Les fichiers de nos containers et images ne sortent pas de n'importe ou! </p>
<h2 id="exercices-4"><a class="header" href="#exercices-4">Exercices</a></h2>
<p>Lancer un container <code>httpd:alpine</code> nomm√© <code>filesystem</code> et y cr√©er un fichier. Trouver l'emplacement des fichiers du container sur la machine h√¥te.</p>
<ul>
<li><code>docker exec -it filesystem bash</code> avec <code>touch somefile</code> pour cr√©er un fichier</li>
<li><code>docker exec filesystem sh -c 'touch somefile'</code> pour les pros ;)</li>
<li><code>docker -h</code> est toujous notre ami!</li>
</ul>
<hr />
<p>Trouver l'emplacement des fichiers de l'image <code>httpd:alpine</code> sur la machine h√¥te. </p>
<ul>
<li>il est conseill√© de ne toucher √† ces fichiers qu'avec les yeux... </li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="docker---bind-mount"><a class="header" href="#docker---bind-mount">Docker - bind mount</a></h1>
<pre><code># mount file (or folder) /tmp/myfile in container at /myfile
# short syntax: -v SOURCE:DEST
docker run -v /tmp/myfile:/myfile -d httpd:alpine

# long syntax, equivalent of short syntax
# recommended by Docker but both work just as fine
docker run --mount type=bind,source=/tmp/myfile,target=/myfile -d httpd:alpine

# on oublie pas... 
docker run -h
</code></pre>
<h2 id="exercices-5"><a class="header" href="#exercices-5">Exercices</a></h2>
<p>Cr√©er un fichier <code>/tmp/index.html</code> avec contenant <code>&quot;Hello Docker!&quot;</code></p>
<pre><code>echo 'Hello Docker!' &gt; /tmp/index.html
</code></pre>
<p>Lancer un container <code>httpd:alpine</code> <strong>montant le fichier <code>/tmp/index.html</code> sur <code>htdocs/index.html</code></strong> (et exposant <code>8085:80</code>)</p>
<ul>
<li>le chemin complet de destination sera peut-√™tre n√©c√©ssaire</li>
<li>tester avec <code>curl localhost:8085</code> ou votre navigateur</li>
<li>lancer une session shell dans le container et modifier le fichier <code>index.html</code>, re-tester <code>localhost:8085</code> et constater les changements
<pre><code># rappel: lancer une session shell
docker exec -it mycontainer sh
</code></pre>
</li>
<li>modifier le fichier <code>/tmp/index.html</code> directement depuis la machine locale, re-tester <code>localhost:8085</code> et constater les changements</li>
</ul>
<hr />
<p>Cr√©er un dossier <code>/tmp/myhtdocs</code> et y copier le fichier <code>index.html</code></p>
<pre><code>mkdir /tmp/myhtdocs
cp /tmp/index.html /tmp/myhtdocs
</code></pre>
<p><strong>Monter le dossier complet</strong> dans votre container afin de pouvoir √©craser l'<code>index.html</code> du container et obtenir le m√™me r√©sultat que pr√©c√©demment</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="docker---volumes"><a class="header" href="#docker---volumes">Docker - Volumes</a></h1>
<pre><code>docker volume -h
# should be sufficient for this one! 
</code></pre>
<h2 id="exercices-6"><a class="header" href="#exercices-6">Exercices</a></h2>
<p>Cr√©er un volume Docker nomm√© <code>httpd_vol</code> </p>
<ul>
<li>cette √©tape est optionnelle pour la suite, mais il serait int√©r√©ssant de comprendre pourquoi</li>
</ul>
<hr />
<p>Lancer un container <code>httpd:alpine</code> nomm√© <code>containervol</code> montant le volume Docker <code>htdocs_vol</code> sur <code>/usr/local/apache2/htdocs</code>. V√©rifier le contenu du dossier <code>htdocs</code> dans le container une fois d√©marr√©. </p>
<ul>
<li>que se passe-t-il si le Volume n'existe pas au pr√©alable?</li>
<li>afficher les montages avec <code>df -h</code> ou <code>mount</code> donne des infos int√©r√©ssantes</li>
</ul>
<hr />
<p>Modifier le contenu de <code>htodcs/index.html</code> dans le container <code>containervol</code> puis stoppez et supprimer le container <code>containervol</code>. Relancer un nouveau container nomm√© <code>containervol2</code> montant <code>httpd_vol</code></p>
<ul>
<li>plut√¥t pratique pour backuper et manipuler des donn√©es lorsqu'une base de donn√©e type Mongo ou MySQL tourne en containeris√©e</li>
</ul>
<hr />
<p>Lancer un container bas√© sur <code>busybox</code> montant <code>httpd_vol</code> en parall√®le 
de <code>containervol2</code> et faites des manipulations sur le fichier dans chacun des containers</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="docker---build"><a class="header" href="#docker---build">Docker - build</a></h1>
<pre><code># Build an image with a Dockerfile
docker build [OPTIONS] CONTEXT_PATH

# Use Dockerfile by default with context from current directory (.)
docker build .

# did you miss me?
docker build -h
</code></pre>
<hr />
<pre><code># Example Dockerfile content to build a custom Apache image

# Image used as base to create our new image
FROM alpine:3.20

# Run some commands to install apache
RUN apk add apache2

# define commands which will be run on startup
CMD [&quot;-DFOREGROUND&quot;]
ENTRYPOINT [&quot;httpd&quot;]
</code></pre>
<h2 id="exercices-7"><a class="header" href="#exercices-7">Exercices</a></h2>
<p>Cr√©er un dossier <code>mybuild</code> et y cr√©er un fichier <code>Dockerfile</code> avec le contenu de l'exemple ci-dessus. <strong>Builder</strong> une image Docker √† partir du Dockerfile et la <strong>tagger <code>myapache:1.0</code></strong></p>
<ul>
<li>votre image doit apparaitre via <code>docker images</code></li>
</ul>
<hr />
<p>Lancer un container utilisant votre image <code>myapache</code> et exposer <code>8089:80</code>, v√©rifier le fonctionnement</p>
<ul>
<li>rappel: <code>curl localhost:8089</code> ou navigateur</li>
<li>essayer de monter des volumes pour obtenir un fichier <code>index.html</code> customis√©!</li>
</ul>
<hr />
<p>Cr√©ez un fichier <code>index.html</code> avec un contenu customis√©, par exemple <code>echo &quot;Hello from file&quot; &gt; index.html</code>.</p>
<p>Modifier votre Dockerfile pour y ajouter une instruction <code>COPY</code> permettant de copier <code>index.html</code> √† l'emplacement <code>/var/www/localhost/htdocs/</code> (emplacement par d√©faut du package Alpine <code>apache2</code>, diff√©rent de l'image officiel <code>httpd</code>). </p>
<p>Testez le fonctionnement de votre image en lan√ßant un container. </p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="docker-compose---basics"><a class="header" href="#docker-compose---basics">Docker Compose - basics</a></h1>
<p>Nous utiliserons l'application Example Voting App pour l'exercice. Elle se trouve dans le dossier <code>~/example-voting-app</code>.</p>
<p>Si besoin, la cloner directement:</p>
<pre><code>git clone https://github.com/PierreBeucher/example-voting-app.git
cd example-voting-app
</code></pre>
<p>Le repository contient un fichier <code>docker-compose.yml</code> avec l'ensemble des <strong>services</strong> d√©finissant notre <strong>stack Docker Compose</strong>:</p>
<ul>
<li>Vote: permet de voter pour Chien ou Chat</li>
<li>Result: permet de voir les r√©sultats des votes</li>
<li>Worker: Traite les votes pour les ins√©rer en base de donn√©e</li>
<li>Redis: g√®re les votes en cours via un syst√®me de queue</li>
<li>DB (Postgres): stocke les r√©sultats</li>
</ul>
<p>Nous utiliserons cette application pour illustrer nos exemples et exercices.</p>
<p>Documentation de r√©f√©rence:</p>
<ul>
<li><a href="https://docs.docker.com/reference/compose-file/">Compose file specs</a></li>
<li><a href="https://docs.docker.com/reference/cli/docker/compose/">Docker Compose CLI</a>
<ul>
<li>Par ex, <code>service</code> et les sous-√©l√©ments sont document√©s dans <a href="https://docs.docker.com/reference/compose-file/services/"><em>Services top-level elements</em></a></li>
</ul>
</li>
</ul>
<p><strong>üîñ Conseil: Ajoutez des liens √† fos favoris, ils seront utiles !</strong></p>
<p><em>Note: la CLI <code>docker-compose</code> standalone a √©t√© d√©pr√©ci√©e en faveur de <code>docker compose</code></em></p>
<hr />
<h2 id="exercices-8"><a class="header" href="#exercices-8">Exercices</a></h2>
<h3 id="lancement-dune-stack-docker-compose"><a class="header" href="#lancement-dune-stack-docker-compose">Lancement d'une stack Docker Compose</a></h3>
<ul>
<li>Utiliser la CLI <code>docker compose</code> pour lancer la stack en mode d√©tach√©e
<pre><code>docker compose --help
</code></pre>
</li>
</ul>
<p>Les services Vote et Result expose une interface web accessible depuis la machine locale une fois lanc√©s. Trouver dans le fichier <code>docker-compose.yml</code> les bindings de ports utilis√©s pour y acc√©der via votre navigateur.</p>
<hr />
<h3 id="configuration-de-services-docker-compose"><a class="header" href="#configuration-de-services-docker-compose">Configuration de services Docker Compose</a></h3>
<p>Modifier le service Redis pour:</p>
<ul>
<li>Utiliser l'image <code>redis:7.2.1</code></li>
<li>Nommer le container <code>my_redis</code> au d√©marrage</li>
<li>Ajouter une variable d'environnement <code>FOO=BAR</code> au runtime du container</li>
</ul>
<h3 id="fichier-env-et-variables-denvironnement"><a class="header" href="#fichier-env-et-variables-denvironnement">Fichier <code>.env</code> et variables d'environnement</a></h3>
<p>Il est possible de r√©f√©rencer des variables d'environnements dans notre fichier <code>docker-compose.yml</code> et de sp√©cifier un fichier <code>.env</code> contenant des variables d'environnements par d√©faut. Par exemple:</p>
<pre><code># .env example
DOTENV_POSTGRES_USER: &quot;postgres&quot;
DOTENV_POSTGRES_PASSWORD: &quot;postgres&quot;
</code></pre>
<p>Cr√©er un fichier <code>.env</code> et modifier le service <code>db</code> pour utiliser les valeurs de ce fichier plut√¥t que des valeurs hardcod√©es.</p>
<h3 id="healthcheck--depends-on"><a class="header" href="#healthcheck--depends-on">Healthcheck &amp; depends on</a></h3>
<p>Faisons en sorte de d√©marrer le service Worker apr√®s nous √™tes assur√© que la base de donn√©e Postgres soit disponible:</p>
<p>Ajouter une instruction <code>healthcheck</code> au service <code>db</code>:</p>
<ul>
<li>Faire un bind mount du script <code>resources/healthchecks/postgres.sh</code> dans le container</li>
<li>Configurer <code>healthcheck</code> pour lancer le script toutes les 5s afin de v√©rifier la &quot;healthiness&quot; du service</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="build-avec-docker-compose"><a class="header" href="#build-avec-docker-compose">Build avec Docker Compose</a></h1>
<p><code>docker compose build</code> permet de lancer des builds d'images Docker en sp√©cifiant le dossier de contexte, le Dockerfile, etc. de fa√ßon similaire √† <code>docker build</code>.</p>
<h2 id="exercices-9"><a class="header" href="#exercices-9">Exercices</a></h2>
<p>Les <code>Dockerfile</code> des services <code>result</code> et <code>worker</code> sont pr√©sents dans des sous-dossiers correspondants √† leurs noms (i.e. <code>result/Dockerfile</code>) mais le build des images n'est pas manag√© par Docker Compose avec la configuration actuelle.</p>
<p>Modifier la configuration des services <code>result</code> et <code>worker</code> dans <code>docker-compose.yml</code> pour indiquer l'emplacement de build √† Docker Compose.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="docker-compose-cli"><a class="header" href="#docker-compose-cli">Docker Compose CLI</a></h1>
<p>La plupart des commandes <code>docker</code> ont leurs √©quivalents avec <code>docker compose</code>, mais leurs fonctionnalit√©s sont adapt√©es √† la gestion de stack multi-container et les fonctionnalit√©s ne sont pas toujours √©quivalentes.</p>
<pre><code># Rappel
docker compose --help
</code></pre>
<h2 id="exercices-10"><a class="header" href="#exercices-10">Exercices</a></h2>
<p>Utiliser une commande permettant de <strong>puller</strong> l'ensemble des images de la stack en parall√®le.</p>
<ul>
<li>Permet de gagner du temps lors du pull de nombreuses images</li>
</ul>
<hr />
<p>Lancer la stack Compose avec les options suivantes:</p>
<ul>
<li>Mode d√©tach√©e (Tout comme <code>docker</code>, <code>docker compose</code> lance les containers en mode interactif par d√©faut)</li>
<li>Forcer la r√©cr√©ation des containers d√©j√† existants</li>
</ul>
<hr />
<p>Lancer la stack puis modifier le fichier <code>docker-compose.yml</code> pour changer le port expos√© de <code>result</code> pour <code>5002</code>. Appliquer les changements √† la stack avec une commande <code>docker compose</code>.</p>
<hr />
<p>Quelques manipulations:</p>
<ul>
<li>Arr√™ter, d√©marrer puis re-d√©marrer la stack</li>
<li>Lister les images utilis√©es par la stack</li>
<li>Lister les containers de la stack</li>
<li>Afficher les logs de l'ensemble des containers de la stack</li>
<li>Afficher les logs d'un container de la stack et suivre les changements</li>
<li>Executer une session shell interactive dans le container <code>vote</code></li>
<li>Arr√™ter et supprimer la stack, puis ne lancer que le service <code>vote</code></li>
<li>Arr√™ter et supprimer la stack</li>
</ul>
<p>Ces commandes seraient possibles directement avec <code>docker</code> en y sp√©cifiant les options requises. <code>docker compose</code> int√©ragi avec le Daemon Docker tout comme <code>docker</code>.</p>
<hr />
<p>Plusieurs stacks peuvent co√©xister en s'assurant qu'il n'y a pas de conflits de ports ou autre.</p>
<p>Copier le fichier <code>docker-compose.yml</code> et nommer cette copie <code>docker-compose-bis.yml</code> puis lancer 2 stacks en parall√®le</p>
<ul>
<li>Celle utilisant <code>docker-compose.yml</code> doit √™tre nomm√© <code>app</code></li>
<li>Celle utilisant <code>docker-compose-bis.yml</code> doit √™tre nomm√©e <code>app-bis</code></li>
<li>Attention aux conflits de nom de container et ports: le nom des containers doivent √™tre uniques ainsi que les ports expos√©es sur la machine</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="docker-compose---ateliers-avanc√©s"><a class="header" href="#docker-compose---ateliers-avanc√©s">Docker Compose - ateliers avanc√©s</a></h1>
<h2 id="volumes"><a class="header" href="#volumes">Volumes</a></h2>
<p>Configuration de Volume: configurer un volume persistant pour le service <code>postgres</code>. Il doit √™tre conserv√© m√™me en cas de destruction du container ou de la stack Compose. </p>
<ul>
<li>Ajouter un volume <code>db-data</code></li>
<li>Configurer le service <code>db</code> pour utiliser le volume <code>db-data</code> √† l'emplacement <code>/var/lib/postgresql/data</code></li>
</ul>
<h2 id="r√©seaux"><a class="header" href="#r√©seaux">R√©seaux</a></h2>
<p>Configuration de R√©seaux:</p>
<ul>
<li>Ajouter un r√©seau <code>app-network</code></li>
<li>Configurer l'ensemble des services pour que les containers soient associ√©s au r√©seau <code>app-network</code> et relancer la stack</li>
</ul>
<h2 id="variables-denvironnement"><a class="header" href="#variables-denvironnement">Variables d'environnement</a></h2>
<p>Docker Compose permet de d√©finir un fichier de variable d'environnement global qui seront affect√©es √† chaque container. </p>
<ul>
<li>Trouver dans la documentation la fonctionnalit√© correspondante</li>
<li>Remplacer les variables d'environnement du service <code>db</code> dans <code>docker-compose.yml</code> et par le fichier de variable d'environnement utilis√© par Compose</li>
</ul>
<p>Docker Compose permet de d√©finir des variables qui seront substitu√©es aux variables d'environnement.</p>
<ul>
<li>Modifier <code>docker-compose.yml</code> pour d√©finir la version du service <code>redis</code> pour qu'elle utilise la variable d'environnement <code>REDIS_VERSION</code> si possible, et <code>alpine</code> par d√©faut:</li>
<li>D√©finir la variable d'environnement <code>REDIS_VERSION=5.0.7-alpine</code> et relancer la stack. V√©rifier que le container <code>redis</code> utilise l'image <code>redis:5.0.7-alpine</code></li>
</ul>
<h2 id="override-docker-composeyml"><a class="header" href="#override-docker-composeyml">Override <code>docker-compose.yml</code></a></h2>
<p>Docker Compose permet d'utiliser plusieurs fichiers de configuration <code>.yml</code> pour √©tendre une configuration de base.</p>
<ul>
<li>Trouver dans la documentation la r√©f√©rence √† ce m√©chanisme d'extention des configurations</li>
<li>Cr√©er un fichier <code>docker-compose.dev.yml</code> √©tendant <code>docker-compose.yml</code> tel que:
<ul>
<li>le service <code>vote</code> monte le code source <code>vote/</code> √† l'emplacement <code>/app</code></li>
<li>le service <code>vote</code> utilise la commande <code>python -m flask run -h 0.0.0.0 -p 80</code></li>
<li>le service <code>vote</code> dispose des variables d'environnements:
<pre><code>FLASK_APP=app.app
FLASK_ENV=development
</code></pre>
</li>
</ul>
</li>
<li>Relancer la stack en combinant <code>docker-compose.yml</code> et <code>docker-compose.dev.yml</code></li>
<li>Renommer <code>docker-compose.dev.yml</code> de fa√ßon √† pouvoir lancer la stack avec <code>docker-compose.yml</code> et le fichier d'override avec uniquement la commande <code>docker compose up -d</code> sans aucune autre option</li>
</ul>
<p>Cette configuration permet de monter le code source de l'application Vote (Python) directement dans le container et de relancer l'application dynamiquement au sein du container sans avoir √† re-builder ou red√©marrer le container.</p>
<p>Cette m√©thode utilise les fonctionnalit√©s de Flask (serveur web Python) mais la plupart des frameworks permettent un setup similaire pour les environnement de d√©veloppement.</p>
<p>Il est ainsi possible de d√©finir une configuration de base Docker Compose avec des overrides selon diff√©rent contextes (dev, CI, production, etc.)</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="bridge-networking"><a class="header" href="#bridge-networking">Bridge networking</a></h1>
<p>Quelques exercices sur Bridge networking avec Docker.</p>
<h1 id="exercices-11"><a class="header" href="#exercices-11">Exercices</a></h1>
<p>Lancer la stack <code>docker-compose.yml</code>. Par d√©faut, un r√©seau est cr√©√© et attach√© √† chaque container.</p>
<ul>
<li>Identifier le r√©seau <code>bridge</code> cr√©√© et utilis√© par la stack par d√©faut
<ul>
<li>Utiliser la CLI Docker: <code>docker network --help</code> </li>
</ul>
</li>
<li>Identifier l'ensemble des r√©seaux actuellement existant et le Driver utilis√© par chacun</li>
<li>Inspecter le r√©seau utilis√© par la stack Compose et:
<ul>
<li>Trouver la liste des containers associ√©s au r√©seau</li>
<li>Identifier le subnet utilis√© par le r√©seau</li>
</ul>
</li>
</ul>
<hr />
<p>Quid de l'isolation des r√©seaux Bridge? Par d√©faut, les containers sur un m√™me r√©seau sont joignables par leur nom (i.e. le container <code>vote</code> est joignable via le hostname <code>vote</code>). Docker effectue une r√©solution DNS interne.</p>
<p>Isolons les containers de notre stack:</p>
<ul>
<li>Configurer les r√©seaux <code>vote-net</code> et <code>result-net</code></li>
<li>Isoler <code>vote</code>, <code>redis</code>, <code>worker</code> dans le r√©seau <code>vote-net</code></li>
<li>Isoler <code>worker</code>, <code>db</code> et <code>result</code> dans le r√©seau <code>result-net</code></li>
<li><em>Note: le container <code>worker</code> sera dans 2 r√©seaux: <code>vote-net</code> et <code>result-net</code></em></li>
</ul>
<p>Seul <code>worker</code> pourra communiquer avec chaque container. <code>vote</code> / <code>redis</code> et <code>db</code> / <code>result</code> seront mutuellement isol√©s dans leurs r√©seaux respectifs. </p>
<p>V√©rifier la <em>non-connectivit√©</em> entre le container <code>vote</code> et  <code>result</code></p>
<ul>
<li>Lancer une session shell sur <code>vote</code>  et essayer de joindre <code>result</code>
<pre><code class="language-sh">docker exec -it vote sh

# Need curl and/or ping ?
# Use 'apk add curl iputils-ping' 
# or 'apt update &amp;&amp; apt install -y curl iputils-ping'

# Try to connect
$ curl result

# Check DNS resolution
$ getent hosts result
$ getent hosts worker
</code></pre>
</li>
</ul>
<hr />
<p>Docker peut aussi connecter et d√©connecter des containers d'un r√©seau √† la vol√©e (sans besoin de red√©marrer ou recr√©er un container).</p>
<ul>
<li>Connecter le container <code>vote</code> manuellement au r√©seau <code>result-net</code></li>
<li>V√©rifier √† nouveau la connectivit√©</li>
<li>D√©connecter le container <code>vote</code> de <code>result-net</code></li>
</ul>
<hr />
<p>Configuration r√©seau customis√©e avec Docker Compose</p>
<ul>
<li>Ajouter un r√©seau bridge <code>my-bridge</code> dans <code>docker-compose.yml</code> et configurer chaque container pour utiliser ce r√©seau</li>
<li>Modifier la configuration de <code>my-bridge</code> pour:
<ul>
<li>Forcer l'utilisation du driver r√©seau <code>bridge</code></li>
<li>Affecter un nom sp√©cifique <code>named-bridge</code></li>
<li>Utiliser le subnet <code>172.42.0.0/16</code> </li>
</ul>
</li>
<li>Appliquer les configurations et inspecter le r√©seau <code>my-named-bridge</code> pour v√©rifier les configurations </li>
</ul>
<hr />
<p>Il est aussi possible d'utiliser un r√©seau d√©j√† existant par ailleurs:</p>
<ul>
<li>Cr√©er un r√©seau Bridge nomm√© <code>my-external-network</code>
<ul>
<li><code>docker network --help</code></li>
</ul>
</li>
<li>Configurer les services pour utiliser ce r√©seau d√©j√† existant et appliquer les configurations </li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="bridge-networking---advanced"><a class="header" href="#bridge-networking---advanced">Bridge networking - advanced</a></h1>
<p>Recherchons comment Docker int√©ragi avec le syst√®me Linux pour manager les r√©seaux et interfaces:</p>
<ul>
<li>Lancer la stack Compose </li>
<li>Trouver l'interface r√©seau Linux sous-jacente du r√©seau Docker utilis√© par la stack
<ul>
<li>Les interfaces r√©seaux sont les <em>devices</em> Linux tels que <code>eth0</code>, <code>lo</code> (loop local), etc.</li>
<li>Les commandes <code>nmcli device status</code> ou <code>ifconfig</code> permettent d'afficher les interfaces r√©seaux</li>
</ul>
</li>
<li>Trouver l'entr√©e de la table de routage permettant de rediriger les packets r√©seaux vers cette interface r√©seau
<ul>
<li>Utiliser <code>ip route</code> ou <code>netstat -rn</code></li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="host-networking"><a class="header" href="#host-networking">Host networking</a></h1>
<p>Configurer <code>docker-compose.yml</code> pour:</p>
<ul>
<li>Utiliser le network <code>host</code> pour chacun des services</li>
<li>Lancer la stack et v√©rifier que chacun des services est <code>Up</code></li>
<li>Se connecter au service Vote et Worker pour v√©rifier leur fonctionnement</li>
<li>Trouver l'adresse IP du container <code>worker</code> - si elle existe</li>
</ul>
<hr />
<ul>
<li>Identifier le r√©seau Docker utilisant le driver <code>host</code></li>
<li>Essayer de cr√©er un autre r√©seau Docker utilisant le driver <code>host</code> </li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="bind-mount-avanc√©"><a class="header" href="#bind-mount-avanc√©">Bind Mount avanc√©</a></h1>
<h1 id="exercices-12"><a class="header" href="#exercices-12">Exercices</a></h1>
<p><em>Besoin: afin de conserver les donn√©es PostgreSQL sur la machine locale m√™me si le container est supprim√© et pour faciliter le processus de backup, vous cherchez une solution pour que les donn√©es de la BDD soient persist√©es. Un <strong>Bind Mount</strong> vous parait une bonne solution.</em></p>
<ul>
<li>Configurer le service <code>db</code> pour monter le dossier local <code>/home/docker/db-data</code> √† l'emplacement <code>/var/lib/postgresql/data</code> </li>
<li>Red√©marrer le container de la stack pour prendre en compte les configurations</li>
<li>Observer le contenu du dossier <code>/home/docker/db-data</code></li>
</ul>
<hr />
<p><em>Besoin: vous devez configurer plus finement la base de donn√©e via un fichier de configuration <code>postgresql.conf</code> fourni par votre administrateur syst√®me et qui doit √™tre utilis√© par la BDD:</em></p>
<pre><code># Full content of postgresql.conf to be mounted in container
listen_addresses = '*'
temp_file_limit = 1000
</code></pre>
<ul>
<li>Trouver l'emplacement auquel le fichier doit √™tre mont√© dans le container <code>db</code> bas√© sur l'image <code>postgres</code>
<ul>
<li>La documentation des images Docker disponible sur Docker Hub indique g√©n√©ralement ces use-cases typiques</li>
<li>Pour <code>postgres</code> il faudra passer un flag de configuration au binaire lanc√© au d√©marrage du container</li>
</ul>
</li>
<li>Monter le fichier de configuration via un Bind Mount avec les contraintes:
<ul>
<li>le fichier de configuration doit √™tre mont√© en <strong>read-only</strong> (lecture seule)</li>
<li>D√©finir l'option <em>Bind Propagation</em> √† <code>rprivate</code></li>
</ul>
</li>
<li>Appliquer les modifications <strong>sans red√©marrer le container</strong>, √† la place <em>envoyer un signal <code>SIGHUP</code> au container pour reloader la configuration</em></li>
</ul>
<p><em>De nombreux applicatifs utilisent <code>SIGHUP</code> pour recharger une configuration sans avoir √† faire un red√©marrage complet, cette feature n'est pas sp√©cifique √† Docker mais n√©anmoins tr√®s pratique.</em> </p>
<hr />
<p><em>Besoin: vous souhaitez configurer une procedure de backup des donn√©es via un au container <code>postgres</code> qui fera un dump r√©gulier de la BDD</em></p>
<p>Lancer un container utilisant permettant d'effectuer un backup:</p>
<ul>
<li>utiliser la m√™me image que le service <code>db</code></li>
<li>monter un dossier sp√©cifique permettant de persister les backups (par ex. un bind mount <code>$PWD/backup:/backup</code>)</li>
<li>supprimer automatiquement le container lorsqu'il s'arr√™tera</li>
<li>lancer directement la commande de backup, par exemple:
<pre><code>PGPASSWORD=postgres pg_dumpall -h db -c -U postgres -w &gt; /backup/my-backup.sql
</code></pre>
<ul>
<li>Attention: pour r√©soudre le nom d'h√¥te <code>db</code> le container de backup doit se trouver sur le m√™me r√©seau.</li>
</ul>
</li>
</ul>
<p><em>Il est possible de monter le m√™me dossier/fichier sur plusieurs containers, pratique dans divers situations comme le backup de donn√©es</em></p>
<p>Bonus: configurer une t√¢che <em>cron</em> qui lancera toutes les heures notre backup. Pour cr√©er une t√¢che cron:</p>
<pre><code># run cron editor for user
crontab -e

# specify cronjob to run every hour
0 * * * *   COMMAND 
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="docker-volumes"><a class="header" href="#docker-volumes">Docker Volumes</a></h1>
<p>Exercices sur les <strong>volumes</strong> Docker. Quelques rappels: </p>
<pre><code># as usual
docker volume --help
docker volume create --help

# create a volume named myvolume
docker volume create myvolume

# run a container and attach a volume
docker run -v myvolume:/data some_image
</code></pre>
<h2 id="exercices-13"><a class="header" href="#exercices-13">Exercices</a></h2>
<p><em>Besoin: vous souhaitez g√©rer les donn√©es Postgres via un volume plut√¥t qu'un bind mount afin de limiter l'acc√®s aux donn√©es depuis la machine locale et faciliter les proc√©dures de backup</em></p>
<p>Modifier <code>docker-compose.yml</code> pour:</p>
<ul>
<li>configurer un volume <code>psqsl-data</code> et</li>
<li>monter ce volume √† l'emplacement <code>/var/lib/postgresql/data</code> du service <code>db</code></li>
<li>red√©marrer le service <code>db</code> pour prendre en compte les modifications</li>
</ul>
<p>Une fois effectu√©:</p>
<ul>
<li>Lister les volumes existants et trouver le volume cr√©√© par Docker Compose</li>
<li>Trouver l'emplacement des donn√©es du volume sur le disque local</li>
</ul>
<p>Cleanup: supprimer la stack Docker Compose et les volumes utilis√©s par Postgres </p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="montage-tmpfs"><a class="header" href="#montage-tmpfs">Montage <code>tmpfs</code></a></h1>
<p>Exercices sur le montage de volume de type <em>tmpfs</em>*</p>
<h2 id="exercices-14"><a class="header" href="#exercices-14">Exercices</a></h2>
<p><em>Contexte: les donn√©es Redis sont dans notre cas consid√©r√©es comme √©ph√©m√®res et ne doivent pas √™tre persist√©es sur le disque ou dans le writable layer du container. De plus, pour optimiser les performances les donn√©es Redis doivent √™tre stock√©es en m√©moire directement.</em></p>
<p>Modifier <code>docker-compose.yml</code> pour:</p>
<ul>
<li>configurer un volume de type <code>tmpfs</code> sur le service <code>redis</code> √† l'emplacement <code>/data</code></li>
<li>limiter la taille du volume √† <code>500Mo</code></li>
<li>red√©marrer le service pour prendre en compte les modifications</li>
</ul>
<p>Lancer une session shell dans le container <code>redis</code> et:</p>
<ul>
<li>cr√©er un fichier test 
<pre><code>echo test &gt; /data/test 
</code></pre>
</li>
<li>red√©marrer le container</li>
<li>v√©rifier l'√©xistence du fichier pr√©c√©demment cr√©√©</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="container-layer-data"><a class="header" href="#container-layer-data">Container Layer data</a></h1>
<p>Quelques exercices de manipulation des donn√©es d'un container</p>
<h2 id="exercices-15"><a class="header" href="#exercices-15">Exercices</a></h2>
<p>Lancer une session shell dans le container <code>vote</code> (<code>docker exec -it vote sh</code>) et:</p>
<ul>
<li>Cr√©er un fichier <code>/test.txt</code> avec le contenu <code>test</code>
<pre><code>echo test &gt; /test.txt
</code></pre>
</li>
<li>Editer le fichier <code>app.py</code> et remplacer les options A et B <strong>Cat</strong> et <strong>Dog</strong> par <strong>Windows</strong> et <strong>Mac</strong>
<ul>
<li>installer un editeur avec <code>apt update &amp;&amp; apt install nano</code> si besoin (<code>ctrl+O</code>: sauvegarder et <code>ctrl+X</code>: exit) </li>
</ul>
</li>
<li>Quitter et red√©marrer le container</li>
<li>Se connecter √† <code>localhost:5000</code> et constater les changements</li>
</ul>
<p><em>Il est fr√©quent d'avoir √† √©diter des fichiers au sein d'un container dans des environnements de dev ou test, et d'y installer des utilitaires &quot;on the fly&quot; - c'est cependant d√©conseill√© en production: les changements seraient perdus en cas de re-cr√©ation du container et 
pourrait modifier le comportement du container.</em></p>
<hr />
<p><strong>Inspecter</strong> le container <code>vote</code> et trouver l'emplacement des donn√©es du layer container sur le disque local. </p>
<p><em>Il est possible de modifier directement les donn√©es depuis le disque... mais c'est tr√®s fortement d√©conseill√© et risque la corruption de l'installation Docker!</em></p>
<hr />
<p>Supprimer le container <code>vote</code> et le r√©cr√©er puis:</p>
<ul>
<li>Lancer une session shell dans le container et v√©rifier si l'√©tat des fichiers <code>/test.txt</code> et <code>app.py</code></li>
<li>V√©rifier l'existence des donn√©es du container layer sur le disque</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="copy"><a class="header" href="#copy">Copy</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="cli-docker-images"><a class="header" href="#cli-docker-images">CLI Docker: images</a></h1>
<pre><code># list images
docker images # mind the plural!
docker image ls

# S.O.S
docker image -h

# pull an image
docker images pull redis:alpine
docker pull redis:alpine
</code></pre>
<h2 id="exercices-16"><a class="header" href="#exercices-16">Exercices</a></h2>
<p>Inspecter l'image <code>vote</code> de votre stack Example Voting App et trouver l'emplacement sur le disque des fichiers de l'image.</p>
<hr />
<p>Tagger l'image <code>vote</code> de votre stack en <code>vote:newtag</code> et configurer votre stack pour l'utiliser</p>
<hr />
<p>Afficher et comparer l'historique de build de l'image <code>vote</code> de base et <code>vote:newtag</code></p>
<hr />
<p>Import/export d'image</p>
<p>Une image Docker n'est rien d'autre qu'une archive contenant des fichiers. Exportons notre image sous forme d'archive avant de la r√©-importer comme image Docker.</p>
<ul>
<li>Exporter l'image <code>vote:newtag</code> comme archive
<ul>
<li>Trouver la commande adap√©e via <code>docker image --help</code></li>
<li>Cette action peut prendre quelques secondes...</li>
</ul>
</li>
<li>Supprimer l'image Vote de votre syst√®me local
<ul>
<li>L'image ne doit plus apparaitre avec <code>docker images</code></li>
<li>Si besoin, il sera possible de la re-builder from scratch</li>
</ul>
</li>
<li>Re-importer l'image Vote depuis l'archive cr√©√©e pr√©c√©demment
<ul>
<li><code>docker images</code> doit affiche l'image</li>
</ul>
</li>
</ul>
<hr />
<p>Lancer un container bas√© sur <code>vote:newtag</code> et ouvrez une session bash dans le container (<code>docker exec ...</code>) pour modifier le contenu du fichier <code>/app/app.py</code> afin de modifier les options <em>Cat/Dog</em> pour <em>Windows/Mac</em> (les variables <code>options_a|b</code>) Red√©marer le container pour constater les changements.</p>
<p>Il est possible de cr√©er une image Docker directement √† partir d'un container (sans passer par <code>docker build</code>). Ce principe est √©quivalent √† cr√©er une image de VM via un snapshot de VM existante afin de lancer des clones de la VM d'origine.</p>
<p>Cr√©er une nouvelle image √† partir du container modifi√© pr√©c√©demment <strong>sans passer par <code>docker build</code></strong>, tagger cette image <code>voting-app:from-container</code> puis d√©marrer un container √† partir de celle-ci et tester.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="voting-app-build-python-image"><a class="header" href="#voting-app-build-python-image">Voting App: Build Python image</a></h1>
<p>L'appplication Voting App dispose de plusieurs services:</p>
<ul>
<li><strong>Worker</strong>: r√©cup√®re les votes et les stockes en base de donn√©e</li>
<li><strong>Vote</strong>: application web permettant de voter</li>
<li><strong>Result</strong> : permet d'afficher les r√©sultats</li>
</ul>
<p>Objectif de l'exercice: √©crire un Dockerfile pour l'application Vote.</p>
<p>Lien utile: <a href="https://docs.docker.com/engine/reference/builder">Dockerfile reference</a> - l'ensemble des instructions utilisables dans un Dockerfile</p>
<h2 id="exercice---dockerfile-pour-le-service-vote"><a class="header" href="#exercice---dockerfile-pour-le-service-vote">Exercice - Dockerfile pour le service Vote</a></h2>
<p>Le code du service Vote se trouve dans <code>vote/</code>:</p>
<ul>
<li><code>app.py</code> est le fichier applicatif permettant de lancer l'application</li>
<li><code>requirements.txt</code> contiens les d√©pendences de l'application</li>
</ul>
<p>Pour l'instant le service utilise une image Docker d√©j√† build√©e:</p>
<pre><code>services:
  vote:
    image: crafteo/example-voting-app-vote
</code></pre>
<p>Nous allons faire en sorte de builder notre propre service Vote selon les contraintes suivantes:</p>
<ul>
<li>
<p>Utiliser <strong>Python 3.9</strong> ou plus r√©cente </p>
<ul>
<li>Chercher sur <a href="https://hub.docker.com/">Docker Hub</a> une image Python correspondante</li>
</ul>
</li>
<li>
<p>L'ensemble du code source du service (fichiers dans <code>/vote</code>) doit √™tre <strong>copi√©e dans l'image Docker</strong></p>
</li>
<li>
<p>L'image Docker doit contenir l'ensemble du service. Pour <strong>installer les d√©pendences</strong>, utiliser la commande</p>
<pre><code>pip install -r requirements.txt
</code></pre>
</li>
<li>
<p>La commande qui doit √™tre lanc√©e au d√©marrage du container est:</p>
<pre><code>gunicorn app:app -b 0.0.0.0:80
</code></pre>
<p>et doit √™tre <strong>√©xecut√©e depuis le dossier contenant l'ensemble du code source</strong> du service (le service exposera le port 80 par d√©faut une fois lanc√©)</p>
</li>
</ul>
<p>Exercices:</p>
<ul>
<li>Ecrire un fichier <code>vote/Dockerfile</code> permettant de builder l'image du service Vote</li>
<li>Builder votre image Vote et la tagger <code>vote:local</code> (mettre √† jour la <code>docker-compose.yml</code> en cons√©quence)</li>
<li>Lancer la stack avec votre nouvelle image <code>vote</code></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="optimization-de-build"><a class="header" href="#optimization-de-build">Optimization de build</a></h1>
<p>Probl√®mes typiques de build: </p>
<ul>
<li>temps de build (notamment download des d√©pendances)</li>
<li>taille finale de l'image (temps de push/pull) </li>
<li>contenu de l'image: ne pas y copier des fichiers par accident (secret, token, etc.)</li>
</ul>
<p>Documentation de r√©f√©rence:</p>
<ul>
<li><a href="https://docs.docker.com/develop/develop-images/dockerfile_best-practices">Dockerfile best practices</a></li>
</ul>
<h2 id="exercices-17"><a class="header" href="#exercices-17">Exercices</a></h2>
<ul>
<li>Ajouter un fichier <code>.dockerignore</code> permettant de filtrer Dockerfile du contexte</li>
<li>Changer les instructions de build pour n'invalider le cache de <code>pip install</code> qu'en cas de modification de <code>requirements.txt</code></li>
<li>Utiliser une image <code>alpine</code> pour r√©duire la taille finale de l'image</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="entrypoint-vs-cmd"><a class="header" href="#entrypoint-vs-cmd">ENTRYPOINT vs CMD</a></h1>
<p>Tableau de correspondance <code>ENTRYPOINT</code> vs. <code>CMD</code>: <a href="https://docs.docker.com/engine/reference/builder/#understand-how-cmd-and-entrypoint-interact">Voir la documentation Docker</a></p>
<hr />
<h2 id="exercice-d√©finir-entrypoint-et-cmd"><a class="header" href="#exercice-d√©finir-entrypoint-et-cmd">Exercice: d√©finir ENTRYPOINT et CMD</a></h2>
<p>D√©finir <code>ENTRYPOINT</code> et <code>CMD</code> afin d'avoir une commande lanc√©e par Docker dans le container r√©pondant √† divers contraintes.</p>
<h3 id="exemple"><a class="header" href="#exemple">Exemple</a></h3>
<pre><code># Le container sera lanc√© avec la commande
#   gunicorn app:app -b 0.0.0.0:80
CMD [ &quot;gunicorn&quot;, &quot;app:app&quot;, &quot;-b&quot;, &quot;0.0.0.0:80&quot; ]
</code></pre>
<p>Pour tester:</p>
<pre><code># Update vote Dockerfile and build
docker compose build vote

# Run vote container
# COMMAND and ARG will override default COMMAND (CMD)
docker run -d --name test_entrypoint --rm vote:local [COMMAND] [ARG...]
# or
docker compose run vote [COMMAND] [ARG...]


# Check running processus
docker top test_entrypoint -o pid,command
# or
docker compose top vote -o pid,command
# Output like
#   PID   COMMAND
#   7767  /usr/local/bin/python /usr/local/bin/gunicorn app:app -b 0.0.0.0:80

# stop and remove container
docker stop test_entrypoint
# or
docker compose down vote
</code></pre>
<h3 id="cas-1"><a class="header" href="#cas-1">Cas 1</a></h3>
<p>La commande lanc√©e au d√©marrage par d√©faut doit √™tre:</p>
<pre><code>gunicorn app:app -b 0.0.0.0:80
</code></pre>
<p>Il doit √™tre possible d'overrider les options de <code>gunicorn</code> d√©finies par d√©faut (i.e. overrider l'usage de <code>-b 0.0.0.0:80</code>)</p>
<p>R√©sultat attendu:</p>
<pre><code>#
# Sans argument suppl√©mentaire
#
docker compose run vote
#
# gunicorn app:app -b 0.0.0.0:80
#

#
# Arguments: --log-level DEBUG
#
docker compose run vote --log-level DEBUG
#
# gunicorn app:app --log-level DEBUG
#
</code></pre>
<p>Cette configuration peut-√™tre utilis√©e pour fournir une image lan√ßant notre serveur Vote en permettant √† l'utilisateur final de passer √† <code>gunicorn</code> des options diff√©rentes (comme un port diff√©rent ou un niveau de debug plus √©l√©v√©)</p>
<h2 id="cas-2"><a class="header" href="#cas-2">Cas 2</a></h2>
<p>La commande lanc√©e au d√©marrage par d√©faut doit √™tre:</p>
<pre><code>gunicorn app:app -b 0.0.0.0:80
</code></pre>
<p>Il doit √™tre possible de passer des options suppl√©mentaires √† <code>gunicorn</code> tout en <strong>conservant l'usage de <code>-b 0.0.0.0:80</code> par d√©faut</strong></p>
<p>R√©sultat attendu:</p>
<pre><code>#
# Sans argument suppl√©mentaire
#
docker compose run vote
#
# gunicorn app:app -b 0.0.0.0:80
#

#
# Arguments: --log-level DEBUG
#
docker compose run vote --log-level DEBUG
#
# gunicorn app:app -b 0.0.0.0:80 --log-level DEBUG
#
</code></pre>
<p>Cette configuration peut-√™tre utilis√©e pour fournir une image lan√ßant notre serveur Vote en permettant √† l'utilisateur final de passer √† <code>gunicorn</code> des options diff√©rentes (comme niveau de debug plus √©l√©v√©) tout en semi-for√ßant l'utilisation de certaines options (dans notre cas, l'utilisation du port 80)</p>
<h2 id="cas-3"><a class="header" href="#cas-3">Cas 3</a></h2>
<p>La commande lanc√©e au d√©marrage par d√©faut doit √™tre:</p>
<pre><code>gunicorn app:app -b 0.0.0.0:80
</code></pre>
<p>Passer un argument au run du container doit overrider int√©gralement la commande lanc√©e par le container par celle en param√®tre.</p>
<p>R√©sultat attendu:</p>
<pre><code>#
# Sans argument suppl√©mentaire
#
docker compose run vote
#
# gunicorn app:app -b 0.0.0.0:80
#

#
# Arguments: --log-level DEBUG
#
docker compose run vote sh
#
# Lance une session shell interactive
#
</code></pre>
<p>Cette configuration peut-√™tre utilis√©e pour fournir une image lan√ßant notre serveur Vote en permettant √† l'utilisateur final de lancer un binaire ou une commande diff√©rent au lancement du container.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="instruction-de-build-dockerfile-avanc√©es"><a class="header" href="#instruction-de-build-dockerfile-avanc√©es">Instruction de build Dockerfile avanc√©es</a></h1>
<p>De nombreuses instructions de build existent pour Dockerfile.</p>
<p>La documentation officielle <a href="https://docs.docker.com/engine/reference/builder/">Dockerfile reference</a> r√©f√©rence l'ensemble des instructions disponibles</p>
<p>Rappel: commandes de build</p>
<pre><code># builder l'image vote
docker build -t vote:builder vote

# lancer l'image vote
docker run -d --name builder1 vote:builder

# lancer une session shell dans le container
# sera utile pour tester vos manipulations!
docker exec -it builder1 bash

# Supprimer un container et une image
docker stop builder1
docker rm builder1
docker rmi vote:builder
</code></pre>
<h2 id="exercice"><a class="header" href="#exercice">Exercice</a></h2>
<hr />
<p>Configurer l'image pour que l'utilisateur <code>crafteo</code> soit utilis√© pour lancer le processus principal</p>
<ul>
<li>Pour cr√©er un utilisateur <code>crafteo</code> sous Linux Alpine:
<pre><code>
adduser -S crafteo
</code></pre>
</li>
</ul>
<p>Il sera n√©c√©ssaire d'ajouter le chemin <code>/home/crafteo/.local/bin</code> au <code>PATH</code> du user <code>crafteo</code> pour √©xecuter les binaires install√©s par Python.</p>
<ul>
<li>Ajouter une instruction au Dockerfile permettant de d√©finir la variable <code>PATH</code> tel que:
<pre><code>PATH=$PATH:/home/crafteo/.local/bin
</code></pre>
</li>
</ul>
<p>Attention: il n'est pas possible de binder un port &lt;1024 avec un utilisateur non-root avec Linux, il sera n√©c√©ssaire d'utiliser un port plus √©lev√©. Modifier votre Dockerfile pour lancer l'application en utilisant le port <code>8080</code>.</p>
<hr />
<p>Ajouter un healthcheck permettant de v√©rifier le fonctionnement de l'image avec <code>curl localhost:80</code>. Ce healthcheck permettra de v√©rifier que l'image est bien active si une r√©ponse est renvoy√©e lors d'un appel √† <code>localhost:80</code></p>
<ul>
<li>Il peut-√™tre n√©c√©ssaire d'installer <code>curl</code> ou d'utiliser une image de base ou il l'est d√©j√†</li>
<li>Pour installer <code>curl</code> sous Linux Alpine:
<pre><code>apk add curl
</code></pre>
</li>
</ul>
<p>Quel est le comportement d'un container Docker en cas de failure du healthcheck?</p>
<hr />
<p>Ajouter un argument <strong>utilisable au build de l'image Vote</strong> permettant de sp√©cifier la version de l'image Python de base √† utiliser. Utiliser la version <code>3.7-alpine</code> par d√©faut.</p>
<p>Par exemple, il devra √™tre possible de lancer les commandes:</p>
<pre><code># utiliser Python 3.8
docker build -t vote:builder --build-arg PYTHON_VERSION=3.8-alpine vote

# utiliser Python 3.7 par d√©faut
docker build -t vote:builder vote
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="harbor"><a class="header" href="#harbor">Harbor</a></h1>
<p>Harbor est un outil de registry Docker. Nous allons cr√©er un compte sur https://demo.goharbor.io pour exp√©rimenter les fonctionnalit√©s. </p>
<h2 id="exercices-18"><a class="header" href="#exercices-18">Exercices</a></h2>
<p>Apr√®s le build locale nos images Example Voting App, pushons les sur une Registry pour les partager !</p>
<p>Aller sur <a href="https://demo.goharbor.io">demo.goharbor.io</a> et cr√©ez-vous un compte (gratuit). </p>
<ul>
<li>Cr√©er un projet <code>example-voting-app</code></li>
<li>Pusher les images Example Voting App dans la registry <code>demo.goharbor.io</code>. Vous devrez:
<ul>
<li>Vous authentifier avec <code>docker login</code></li>
<li>Modifier <code>docker-compose.yml</code> pour sp√©cifier l'URL de Harbor demo pour chaque image</li>
<li>Rebuilder les images avec le tag pointant vers Harbor demo</li>
<li>Pusher vos images avec <code>docker compose push</code> ou <code>docker push</code></li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="docker-hub---registry-docker-officielle"><a class="header" href="#docker-hub---registry-docker-officielle">Docker Hub - Registry Docker officielle</a></h1>
<p>Cette s√©rie d'exercice d√©montrera l'usage de Docker Hub, la registry officielle. Nous allons cr√©er un compte, s'authentifier avec la CLI <code>docker</code> et pusher nos imagees build√©es localement directement sur la registry.</p>
<h2 id="exercices-19"><a class="header" href="#exercices-19">Exercices</a></h2>
<p>Apr√®s le build locale nos images Example Voting App, poussons les sur la Registry!</p>
<p>Aller sur <a href="https://hub.docker.com/">hub.docker.com</a> et cr√©ez vous un compte (gratuit). </p>
<ul>
<li>Avec votre compte, cr√©er un repository sur Docker Hub nomm√© <code>voting-app-vote</code> qui sera utilis√© pour h√©berger l'image <code>vote</code></li>
<li>Pour pouvoir pusher sur la registry, vous aurez besoin de vous authentifier avec <code>docker login</code> apr√®s avoir g√©n√©r√© un token
<ul>
<li>Sur votre <em>profil &gt; Account settings &gt; Security</em> g√©n√©rer un token</li>
<li>Utiliser <code>docker login</code> avec votre ID et token pour vous authentifier</li>
</ul>
</li>
</ul>
<p>Nous avons √† pr√©sent acc√®s au Docker Hub depuis notre machine</p>
<ul>
<li>Modifier <code>docker-compose.yml</code> pour que l'image <code>vote</code>, <code>worker</code> et <code>result</code> build√©e soit nomm√©e selon votre registry</li>
<li>Utiliser <code>docker compose</code> pour pusher l'image <code>vote</code> dans votre domaine Docker Hub</li>
<li>Utiliser <code>docker compose</code> pour pusher l'image <code>worker</code> dans votre domaine Docker Hub - pour lequel vous n'avez pas cr√©√© de repository pour l'instant</li>
<li>Utiliser la CLI <code>docker</code> pour pusher l'image <code>result</code></li>
<li>Modifier <code>docker-compose.yml</code> pour tagger les images <code>1.0</code> et pusher toutes les images en une seule commande</li>
</ul>
<hr />
<p>Les images push√©es sur la registry peuvent maintenant √™tre utilis√©e publiquement. Il est aussi possible de les rendre priv√©es, auquel cas il sera obligatoire de s'authentifier sur la registry avant de pouvoir les puller. </p>
<ul>
<li>Essayer de puller les images construires et push√©es depuis la registry de votre voisin</li>
<li>Essayer de pusher une image construite par vous-m√™me sur la registry de votre voisin</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="self-hosted-docker-registry"><a class="header" href="#self-hosted-docker-registry">Self-hosted Docker Registry</a></h1>
<p>Cette s√©rie d'exercice nous permettra de d√©ployer notre propre registry Docker.</p>
<p>Le Registry Docker se d√©ploie sous forme d'un container Docker, par exemple pour d√©ployer une registry sur votre machine √©coutant sur le port 8080:</p>
<pre><code>docker run -d -p 5010:5000 --name registry registry:2
</code></pre>
<p>Taggons une image pour la pusher sur notre registry locale:</p>
<pre><code>docker pull ubuntu:latest
docker tag ubuntu localhost:5010/ubuntu
docker push localhost:5010/ubuntu
</code></pre>
<p>Pour plus de d√©tails, voir <a href="https://docs.docker.com/registry/deploying/">la documentation officielle Docker</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="dockerizer-une-application-depuis-le-code-source"><a class="header" href="#dockerizer-une-application-depuis-le-code-source">Dockerizer une application depuis le code source</a></h1>
<p>Consid√©rons le contexte suivant:</p>
<p><em>Vous √™tes un op√©rateur travaillant avec une √©quipe de d√©veloppeur. L'√©quipe de dev viens de vous livrer le code source d'une application web que vous devez d√©ployer sous Docker.</em></p>
<p><em>L'application est cod√© en <a href="https://nodejs.org/en/">NodeJS</a> et a pour but d'afficher un message √† partir d'un fichier de configuration. Le code source de l'application se trouve √† l'emplacement suivant: <a href="https://github.com/PierreBeucher/example-voting-app/tree/master/resources/nodejs-sample">NodeJS app</a></em></p>
<p>Les d√©veloppeurs vous donnent les instructions suivantes:</p>
<ul>
<li>L'application peut se lancer avec NodeJS 15+</li>
<li>Pour fonctionner, elle va charger au d√©marrage le fichier de configuration <code>./config.yaml</code> qui doit lui √™tre mis √† disposition. Les devs vous fournissent le fichier de config test√© en d√©veloppement:
<pre><code class="language-yaml"># Message to print when app is accessed via a web browser
message: &quot;Test message from dev&quot;

# Host and port on which to bind server
hostname: 127.0.0.1
port: 8080
</code></pre>
</li>
<li>Instructions d'utilisation de l'application:
<pre><code class="language-sh"># Install Node dependencies
# Require package.json and package-lock.json
npm install

# Run node app
node app.js

# App should not respond to web request
# For example, localhost:8080
</code></pre>
</li>
</ul>
<p>Vous devez <em>dockeriser</em> l'application:</p>
<ul>
<li>Ecrire un <code>Dockerfile</code> permettant de builder l'application</li>
<li>Ecrire un <code>docker-compose.yml</code> permettant de lancer l'application:
<ul>
<li>Assurez-vous de monter un fichier <code>config.yaml</code> dans le container</li>
</ul>
</li>
<li>Lancer l'application et v√©rifier qu'elle soit joignable</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="https--reverse-proxying-avec-traefik"><a class="header" href="#https--reverse-proxying-avec-traefik">HTTPS &amp; Reverse Proxying avec Traefik</a></h1>
<p>Ajoutons des configurations TLS (HTTPS) et un reverse proxy (Traefik). </p>
<ul>
<li>Explorer le contenu de <code>resources/traefik.yml</code></li>
<li>Cr√©er un fichier <code>.env</code> (remplacer <code>&lt;you&gt;</code> par votre nom):
<pre><code>VOTE_URL=vote.&lt;you&gt;.training.crafteo.io
RESULT_URL=result.&lt;you&gt;.training.crafteo.io
</code></pre>
</li>
<li>Lancer la stack avec les overrides Traefik:
<pre><code class="language-sh"># make traefik
docker compose -f docker-compose.yml -f resources/traefik.yml up -d
</code></pre>
</li>
</ul>
<p><code>vote</code> et <code>result</code> sont maintenant expos√©s via:</p>
<ul>
<li><code>https://vote.&lt;you&gt;.training.crafteo.io</code></li>
<li><code>https://result.&lt;you&gt;.training.crafteo.io</code></li>
</ul>
<p><em>Note: le certificat TLS ne sera pas reconnu par votre navigateur, ils sont fournis par <code>(STAGING) Let's Encrypt</code>, une version de test des certificats <a href="https://letsencrypt.org/">Let's Encrypt</a></em></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="docker-quelques-bonnes-pratiques"><a class="header" href="#docker-quelques-bonnes-pratiques">Docker: quelques bonnes pratiques!</a></h1>
<p>Quelques exercices sur les bonnes pratiques avec Docker: limitation de ressources, healthcheck, logging...</p>
<p>Les exercices utiliserons le <code>docker-compose.yml</code> suivant:</p>
<pre><code>version: &quot;3.7&quot;

services:
  db:
    container_name: db
    image: postgres:9.4
    environment:
      POSTGRES_USER: &quot;postgres&quot;
      POSTGRES_PASSWORD: &quot;postgres&quot;

  redis:
    container_name: redis
    image: redis:alpine

  result:
    container_name: result
    image: crafteo/example-voting-app-result
    ports:
      - &quot;5001:80&quot;
      - &quot;5858:5858&quot;

  vote:
    container_name: vote
    image: crafteo/example-voting-app-vote
    ports:
      - &quot;5000:80&quot;

  worker:
    container_name: worker
    image: crafteo/example-voting-app-worker
</code></pre>
<h2 id="exercices-20"><a class="header" href="#exercices-20">Exercices</a></h2>
<p>Se documenter sur les m√©thodes de limitation de ressources pour les containers Docker puis modifier le <code>docker-compose.yml</code> pour limiter la consommation de chaque service:</p>
<ul>
<li>Maximum de 0.2 CPU et 256Mo RAM par service</li>
<li>R√©servation de 0.1 CPU 128Mo de RAM par service</li>
</ul>
<p><em>Note: Docker Compose v3 ignore par d√©faut les param√®tres <code>deploy.resources</code> qui sont r√©serv√©s √† Docker Swarm. Pour les prendre en compte, utiliser <code>--compatibility</code> ou un fichier compose <code>version: &quot;2&quot;</code></em></p>
<hr />
<p>Docker permet de configurer des drivers de Logging. Faire quelques recherches sur les configuration de logging possible avec Docker puis:</p>
<ul>
<li>Lancer un container <code>fluent/fluentd</code> √©coutant montant le volume <code>/tmp/docker-logs:/fluentd/log</code>
<pre><code>docker run -d --rm --name fluentd -v /tmp/docker-logs:/fluentd/log fluent/fluentd
</code></pre>
</li>
<li>Configurer le service <code>db</code> pour utiliser le driver <code>fluentd</code> afin d'envoyer les logs vers le container <code>fluentd</code>
<ul>
<li>Utiliser <code>docker inspect</code> pour obtenir l'IP du container <code>fluentd</code></li>
<li>Ne pas utiliser le nom du container directement qui ne sera pas reconnu </li>
</ul>
</li>
<li>Lancer la stack ainsi configur√©e</li>
</ul>
<p>V√©rifier l'existence des logs dans <code>/tmp/docker-logs</code></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="logging-with-docker-example-elk-stack"><a class="header" href="#logging-with-docker-example-elk-stack">Logging with Docker example: ELK Stack</a></h1>
<p>D√©ployons une stack ELK (Logstash, Elasticearch, Kibana) que nous pourrons utiliser pour obtenir les logs de nos containers:</p>
<p><code>resources/elk-stack.yml</code> contiens les configurations d'une stack ELK. La d√©ployer avec:</p>
<pre><code class="language-sh"># make elk
docker compose -f resources/elk-stack.yml up -d
</code></pre>
<ul>
<li>L'interface Kibana est accessible via <code>http://&lt;host&gt;:8082</code></li>
<li>Explorer le contenu de <code>resources/elk-stack.yml</code> pour y trouver les configurations des diff√©rents services</li>
</ul>
<p>Une fois d√©ploy√©e, lancer une stack de containers avec le logging driver Docker adapt√©. Utiliser le fichier <code>resources/logging.yml</code>:</p>
<pre><code class="language-sh"># make logging
docker compose -f docker-compose.yml -f resources/logging.yml up -d
</code></pre>
<p>Aller sur Kibana (<code>&lt;host&gt;:8082</code>) et:</p>
<ul>
<li>Cliquer sur <em>Discover</em> (bouton avec la boussole)</li>
<li>Vous serez redirig√© sur la page <em>Create index pattern</em>. Entrez <code>logstash-*</code> et cliquer sur <em>Next step</em></li>
<li>Choisissez <code>@timestamp</code> comme <em>Time filter field</em> et confirmer avec <em>Create index pattern</em></li>
<li>Cliquer √† nouveau sur <em>Discover</em> pour acc√©der aux logs </li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="monitoring-example-prometheus--grafana-stack"><a class="header" href="#monitoring-example-prometheus--grafana-stack">Monitoring example: Prometheus + Grafana stack</a></h1>
<p>D√©ployons une stack Prometheus + Grafana que nous pourrons utiliser pour obtenir des metrics sur nos containers (CPU, RAM, etc.) et configurer des alertes. </p>
<p>Cloner le repository Git Prometheus:</p>
<pre><code>git clone https://github.com/PierreBeucher/prometheus.git
</code></pre>
<p>Lancer la stack Docker Compose:</p>
<pre><code class="language-sh">cd prometheus
docker compose up -d
</code></pre>
<ul>
<li>L'interface Grafana est accessible via <code>http://&lt;host&gt;:3000</code> (login: <code>admin</code>, password: <code>Prometheus2023</code>)</li>
<li>Explorer le contenu de <code>docker-compose.yml</code> pour y trouver les configurations des diff√©rents services</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="configuration-avanc√©es-du-docker-daemon"><a class="header" href="#configuration-avanc√©es-du-docker-daemon">Configuration avanc√©es du Docker Daemon</a></h1>
<p>Suite √† l'installation de Docker sur Linux:</p>
<ul>
<li>Docker est install√© comme service Linux (<code>systemd</code>)</li>
<li>La CLI <code>dockerd</code> est utilis√© pour lancer le Docker daemon</li>
<li>Il est possible d'overrider les configurations du daemon via des options CLI au lancement du service ou via un fichier <code>/etc/docker/daemon.json</code> lu par <code>dockerd</code> par d√©faut</li>
</ul>
<p>Quelques infos et rappels:</p>
<ul>
<li>Le <strong>Docker daemon</strong> est aussi appel√© <strong>Docker host</strong> ou <strong>Docker server</strong></li>
<li>Le Docker client (CLI <code>docker</code>) communique avec le client via API REST en utilisant la socket <code>/var/run/docker.sock</code> par d√©faut. Le client peut aussi contacter directement une adresse tel que <code>tcp://127.0.0.1:2375</code> ou <code>tcp://198.265.78.1:2376</code> en fonction des configurations du Daemon</li>
<li>Memo de commandes <code>systemctl</code> utile pour manipuler les services Linux:
<pre><code># restart, stop, get status of docker
sudo systemctl [restart|stop|status|...] docker

# edit systemd file override
# or edit file directly at /lib/systemd/system/docker.service
sudo systemctl edit docker 

# reload after edit
sudo systemctl daemon-reload

# see newest service logs
sudo journalctl -u docker -r
</code></pre>
</li>
</ul>
<h1 id="exercices-21"><a class="header" href="#exercices-21">Exercices</a></h1>
<p>Cr√©er un fichier <code>etc/docker/daemon.json</code> et y configuer les options suivantes pour le Docker daemon:</p>
<ul>
<li>Activer le mode debug</li>
<li>Configurer le daemon Docker pour √©couter sur <code>127.0.0.1:2375</code></li>
<li>Configurer le port binding pour √©couter sur <code>127.0.0.1</code> par d√©faut
<ul>
<li>sinon, un port binding avec <code>docker run -p 80:80 ...</code> √©coutera sur <code>0.0.0.0:80</code> par d√©faut, ce qui peut repr√©senter un risque de s√©curit√©</li>
</ul>
</li>
<li>Ajouter le DNS <code>8.8.8.8</code> </li>
</ul>
<p>Votre Docker daemon √©coute maintenant sur <code>127.0.0.1:2375</code> et n'utilisera plus la socket <code>/var/run/docker.sock</code>. La CLI Docker utilisant cette socket par d√©faut, des configurations suppl√©mentaires seront requises en utilisant la CLI <code>docker</code>. </p>
<p>Red√©marrer le service Docker et tester: </p>
<ul>
<li>Lancer un container exposant un port et v√©rifier que l'adresse d'√©coute est bien <code>127.0.0.1</code></li>
<li>Au sein du container, v√©rifier que le DNS <code>8.8.8.8</code> est bien utilis√©</li>
<li>Afficher les logs du Daemon</li>
</ul>
<hr />
<p>Certains d√©ploiements mettent √† disposition un daemon Docker accessible √† distance. (i.e. le daemon Docker est install√© sur une machine diff√©rente du client Docker)</p>
<p>Cela peut-√™tre utile dans certaines situations, par exemple pour partager un daemon avec une √©quipe de d√©veloppeur ou un syst√®me de CI et acc√©ler le build d'image: le cache de build pourra √™tre r√©utilis√© facilement et ainsi r√©duire le temps de build (pratique dans certains cas ou un build sans cache dure 20+ min et avec cache seulement quelques secondes!)</p>
<p>Un tel d√©ploiement demande de s√©curiser les communications entre le client Docker et le daemon. Utilisant HTTP par d√©faut, il faut y configurer TLS pour passer en HTTPS. </p>
<p>Configurer le daemon Docker pour:</p>
<ul>
<li>√©couter sur <code>127.0.0.1:2376</code></li>
<li>Configurer l'authentification du serveur en TLS - un client pourra ainsi authentifier le serveur lors de son utilisation (similaire √† la connection √† un site web en HTTPS)</li>
<li>(Optionnel) Configurer l'authentification du client en TLS - le client devra s'authentifier aupr√®s du serveur avec un certificate pour pouvoir utiliser le daemon</li>
</ul>
<p>Ce setup s'appelle une double-authentification TLS. Pour ce besoin il faut un certificat et une cl√© pour √™tre utilis√© par le Daemon (idem pour le client):</p>
<ul>
<li>Le client va &quot;truster&quot; un CA (certificate Authority) et le daemon fournira un certificat sign√© par ce CA pour s'authentifier (c'est exactement le m√™me processus en se connectant √† un site web en HTTPS)</li>
<li>Le Daemon va &quot;truster&quot; un CA (g√©n√©ralement le m√™me), et le client devra fournir un certificat sign√© par ce CA pour √™tre autoris√© par le daemon</li>
</ul>
<p>Dans le cadre de l'exercice nous pourrons g√©n√©rer nos propre CA et certificats. Pour g√©n√©rer une cl√© et un certificat autosign√©:</p>
<pre><code># generate CA cert and key
openssl genrsa -out ca.key 4096
openssl req  -nodes -new -x509  -keyout ca.key -out ca.cert

# Generate key for daemon
openssl genrsa -out daemon.key 4096

# Generate CSR for daemon
openssl req -new -sha256 -key daemon.key -out daemon.csr

# Generate cert for daemon signed by CA
openssl x509 -req -in daemon.csr -CA ca.cert -CAkey ca.key -CAcreateserial -out daemon.cert -days 500

# same for client: key, csr and cert
</code></pre>
<p>Points d'attention:</p>
<ul>
<li>Par convention, le port d'√©coute de Docker est <code>2375</code> sans TLS et <code>2376</code> avec TLS. </li>
<li>Le client aura besoin de configuration suppl√©mentaire pour activer TLS et v√©rifier l'authenticit√© du serveur</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
